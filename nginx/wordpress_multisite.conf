# https://www.nginx.com/resources/wiki/start/topics/recipes/wordpress/

map $uri $blogname{
    ~^(?P<blogpath>/[^/]+/)files/(.*) $blogpath ;
}

map $blogname $blogid{
    default -999;
}

server {
    
    listen 80 default_server;
	listen [::]:80 default_server;

    listen 443 ssl default_server;
	listen [::]:443 ssl default_server;

	# Self signed certs generated by the ssl-cert package. Don't use them in a production server!
	include snippets/snakeoil.conf;

    server_name _;

    root /var/www/html;
    index index.php index.html;

    location ~ ^(/[^/]+)?/files/(.+) {
        try_files /wp-content/blogs.dir/$blogid/files/$2 /wp-includes/ms-files.php?file=$2 ;
    }

    #avoid php readfile()
    location ^~ /blogs.dir {
        internal;
        alias /var/www/html/wp-content/blogs.dir;
    }

    if (!-e $request_filename) {
        rewrite /wp-admin$ $scheme://$host$uri/ permanent;
        rewrite ^(/[^/]+)?(/wp-.*) $2 last;
        rewrite ^(/[^/]+)?(/.*\.php) $2 last;
    }

    location / {
        try_files $uri $uri/ /index.php?$args ;
    }

	location ~ \.php$ {
		include snippets/fastcgi-php.conf;
		fastcgi_pass unix:/run/php/php7.4-fpm.sock;
	}

}
